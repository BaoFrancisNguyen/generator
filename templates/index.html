<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur Malaysia - Bas√© sur OpenStreetMap</title>
    
    <!-- Styles existants -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='professional_styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Header professionnel -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">üá≤üáæ</div>
                    <div class="logo-text">
                        <h1>Malaysia OSM Generator</h1>
                        <p>G√©n√©ration bas√©e sur donn√©es OpenStreetMap r√©elles</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="badge badge-success" id="systemStatus">
                        ‚úÖ Syst√®me op√©rationnel
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- S√âLECTION DE ZONE G√âOGRAPHIQUE -->
        <div class="professional-card">
            <div class="card-header">
                <h3 class="card-title">
                    üó∫Ô∏è S√©lection de zone g√©ographique
                </h3>
                <div class="card-badge">OpenStreetMap</div>
            </div>

            <div class="grid grid-2">
                <!-- S√©lection de zone -->
                <div class="form-section">
                    <h3>üìç Choisir la zone d'√©tude</h3>
                    
                    <div class="form-group">
                        <label for="zoneType">Type de zone</label>
                        <select id="zoneType" class="form-control" onchange="updateZoneOptions()">
                            <option value="country">üá≤üáæ Malaisie enti√®re</option>
                            <option value="state">üèõÔ∏è √âtat/Province</option>
                            <option value="city" selected>üèôÔ∏è Ville</option>
                            <option value="district">üèòÔ∏è Quartier/District</option>
                            <option value="custom">üìê Zone personnalis√©e</option>
                        </select>
                    </div>

                    <!-- Options selon le type de zone -->
                    <div id="stateOptions" class="form-group" style="display: none;">
                        <label for="selectedState">√âtat de Malaisie</label>
                        <select id="selectedState" class="form-control">
                            <option value="Selangor">Selangor</option>
                            <option value="Johor">Johor</option>
                            <option value="Perak">Perak</option>
                            <option value="Pahang">Pahang</option>
                            <option value="Penang">Penang</option>
                            <option value="Kedah">Kedah</option>
                            <option value="Kelantan">Kelantan</option>
                            <option value="Terengganu">Terengganu</option>
                            <option value="Negeri Sembilan">Negeri Sembilan</option>
                            <option value="Malacca">Malacca</option>
                            <option value="Perlis">Perlis</option>
                            <option value="Sabah">Sabah</option>
                            <option value="Sarawak">Sarawak</option>
                            <option value="Federal Territory">Federal Territory</option>
                        </select>
                    </div>

                    <div id="cityOptions" class="form-group">
                        <label for="selectedCity">Ville de Malaisie</label>
                        <select id="selectedCity" class="form-control" onchange="updateCityInfo()">
                            <option value="Kuala Lumpur">Kuala Lumpur (1.8M hab.)</option>
                            <option value="George Town">George Town (708K hab.)</option>
                            <option value="Ipoh">Ipoh (657K hab.)</option>
                            <option value="Shah Alam">Shah Alam (641K hab.)</option>
                            <option value="Petaling Jaya">Petaling Jaya (613K hab.)</option>
                            <option value="Johor Bahru">Johor Bahru (497K hab.)</option>
                            <option value="Kota Kinabalu">Kota Kinabalu (452K hab.)</option>
                            <option value="Kuching">Kuching (325K hab.)</option>
                            <option value="Ampang Jaya">Ampang Jaya (315K hab.)</option>
                            <option value="Klang">Klang (290K hab.)</option>
                            <option value="Kajang">Kajang (280K hab.)</option>
                            <option value="Seremban">Seremban (257K hab.)</option>
                            <option value="Sungai Petani">Sungai Petani (246K hab.)</option>
                            <option value="Tawau">Tawau (190K hab.)</option>
                            <option value="Miri">Miri (187K hab.)</option>
                        </select>
                    </div>

                    <div id="districtOptions" class="form-group" style="display: none;">
                        <label for="districtName">Nom du quartier/district</label>
                        <input type="text" id="districtName" class="form-control" 
                               placeholder="Ex: KLCC, Bukit Bintang, Georgetown Heritage">
                        <small class="text-light">Saisissez le nom du quartier ou utilisez la carte</small>
                    </div>

                    <div id="customOptions" style="display: none;">
                        <div class="form-group">
                            <label>Coordonn√©es de la zone personnalis√©e</label>
                            <div class="grid grid-2">
                                <input type="number" id="customLat" class="form-control" 
                                       placeholder="Latitude" step="0.000001">
                                <input type="number" id="customLon" class="form-control" 
                                       placeholder="Longitude" step="0.000001">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customRadius">Rayon (en m√®tres)</label>
                            <input type="range" id="customRadius" min="100" max="10000" value="1000" 
                                   class="form-control" oninput="updateRadiusDisplay()">
                            <small class="text-light">Rayon: <span id="radiusDisplay">1000m</span></small>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary w-100 mt-3" onclick="previewZone()">
                        üîç Pr√©visualiser la zone
                    </button>
                </div>

                <!-- Informations de la zone -->
                <div class="form-section">
                    <h3>üìä Informations de la zone</h3>
                    
                    <div class="data-card">
                        <div class="data-card-header">
                            <div class="data-card-title">Zone s√©lectionn√©e</div>
                        </div>
                        <div class="data-card-body">
                            <div class="data-item">
                                <span class="data-label">Nom:</span>
                                <span class="data-value" id="zoneNameDisplay">-</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Type:</span>
                                <span class="data-value" id="zoneTypeDisplay">-</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Population:</span>
                                <span class="data-value" id="zonePopulationDisplay">-</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Superficie:</span>
                                <span class="data-value" id="zoneAreaDisplay">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="data-card mt-3">
                        <div class="data-card-header">
                            <div class="data-card-title">Estimation OSM</div>
                        </div>
                        <div class="data-card-body">
                            <div class="data-item">
                                <span class="data-label">B√¢timents estim√©s:</span>
                                <span class="data-value" id="estimatedBuildings">-</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Temps de requ√™te:</span>
                                <span class="data-value" id="queryTimeEstimate">-</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Statut API:</span>
                                <span class="data-value" id="apiStatus">üîÑ En attente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARTE DE PR√âVISUALISATION -->
        <div class="professional-card" id="previewMapContainer">
            <div class="card-header">
                <h3 class="card-title">üó∫Ô∏è Pr√©visualisation de la zone</h3>
                <div class="flex gap-2">
                    <button id="loadRealBuildings" class="btn btn-success btn-sm">
                        üèóÔ∏è Charger b√¢timents r√©els
                    </button>
                    <button id="centerOnZone" class="btn btn-secondary btn-sm">
                        üìç Centrer sur zone
                    </button>
                    <button id="clearPreview" class="btn btn-outline btn-sm">
                        üßπ Effacer
                    </button>
                </div>
            </div>
            
            <div class="map-wrapper">
                <div id="previewMap" class="leaflet-map"></div>
                <div id="buildingStats" class="map-legend">
                    <div class="legend-title">Statistiques des b√¢timents</div>
                    <div id="buildingTypesStats">
                        <p class="text-center text-light">Chargez les b√¢timents pour voir les statistiques</p>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="flex flex-between">
                    <div id="mapStatus" class="text-secondary">
                        S√©lectionnez une zone et cliquez sur "Pr√©visualiser"
                    </div>
                    <div class="badge badge-info">
                        <span id="loadedBuildingsCount">0</span> b√¢timents charg√©s
                    </div>
                </div>
            </div>
        </div>

        <!-- CONFIGURATION TEMPORELLE (CONSERV√âE) -->
        <div class="professional-card">
            <div class="card-header">
                <h3 class="card-title">‚è∞ Configuration temporelle</h3>
                <div class="card-badge">Horodatage</div>
            </div>

            <div class="grid grid-2">
                <div class="form-section">
                    <h3>üìÖ P√©riode d'√©tude</h3>
                    
                    <div class="form-group">
                        <label for="startDate">Date de d√©but</label>
                        <input type="date" id="startDate" class="form-control" 
                               value="2024-01-01" onchange="updateEstimation()">
                    </div>

                    <div class="form-group">
                        <label for="endDate">Date de fin</label>
                        <input type="date" id="endDate" class="form-control" 
                               value="2024-01-31" onchange="updateEstimation()">
                    </div>
                </div>

                <div class="form-section">
                    <h3>‚è±Ô∏è Fr√©quence d'√©chantillonnage</h3>
                    
                    <div class="form-group">
                        <label for="freq">Fr√©quence de mesure</label>
                        <select id="freq" class="form-control" onchange="updateEstimation()">
                            <option value="5T">5 minutes (tr√®s d√©taill√©)</option>
                            <option value="15T">15 minutes (d√©taill√©)</option>
                            <option value="30T" selected>30 minutes (standard)</option>
                            <option value="1H">1 heure (efficace)</option>
                            <option value="2H">2 heures</option>
                            <option value="6H">6 heures</option>
                            <option value="12H">12 heures (2x/jour)</option>
                            <option value="1D">1 jour (quotidien)</option>
                            <option value="1W">1 semaine (hebdomadaire)</option>
                            <option value="1M">1 mois (mensuel)</option>
                        </select>
                        <small id="freqInfo" class="text-light">Impact sur la taille du dataset</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ESTIMATION DU DATASET (MISE √Ä JOUR) -->
        <div class="professional-card">
            <div class="card-header">
                <h3 class="card-title">üìä Estimation du dataset final</h3>
                <div class="card-badge">Temps r√©el</div>
            </div>
            
            <div class="stats-container" id="estimationCard">
                <div class="stat-card">
                    <div class="stat-value" id="totalBuildings">-</div>
                    <div class="stat-label">B√¢timents OSM</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalObservations">-</div>
                    <div class="stat-label">Observations totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fileSize">-</div>
                    <div class="stat-label">Taille fichier (~)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="generationTime">-</div>
                    <div class="stat-label">Temps g√©n√©ration (~)</div>
                </div>
            </div>

            <!-- R√©partition par type de b√¢timent -->
            <div class="professional-card mt-3">
                <div class="card-header">
                    <h4 class="card-title">üèóÔ∏è R√©partition par type de b√¢timent</h4>
                </div>
                <div class="grid grid-3" id="buildingTypesBreakdown">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>
        </div>

        <!-- BOUTONS D'ACTION -->
        <div class="professional-card">
            <div class="card-header">
                <h3 class="card-title">üöÄ G√©n√©ration des donn√©es</h3>
            </div>
            
            <div class="text-center p-4">
                <div class="alert alert-info mb-4">
                    <div class="alert-icon">‚ÑπÔ∏è</div>
                    <div>
                        <strong>Nouvelle approche :</strong> Les donn√©es sont g√©n√©r√©es automatiquement 
                        √† partir des vrais b√¢timents trouv√©s sur OpenStreetMap dans la zone s√©lectionn√©e.
                        Les patterns de consommation √©lectrique restent r√©alistes selon vos r√®gles existantes.
                    </div>
                </div>
                
                <div class="flex flex-center gap-3">
                    <button onclick="generateFromOSM()" class="btn btn-primary btn-lg">
                        üèóÔ∏è G√©n√©rer depuis OSM
                    </button>
                    <button onclick="downloadFromOSM()" class="btn btn-success btn-lg">
                        üíæ G√©n√©rer et T√©l√©charger
                    </button>
                    <button onclick="previewOSMData()" class="btn btn-warning">
                        üëÅÔ∏è Aper√ßu des donn√©es
                    </button>
                </div>
            </div>
        </div>

        <!-- ZONE DE CHARGEMENT -->
        <div class="loading-container" id="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">
                <h2>üåè R√©cup√©ration des donn√©es OpenStreetMap...</h2>
                <p id="loadingStatus">Interrogation de l'API Overpass en cours...</p>
                <div class="progress mt-3" style="width: 300px;">
                    <div class="progress-bar" id="loadingProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- R√âSULTATS -->
        <div id="results" class="fade-in" style="display: none;">
            <div id="alerts"></div>
            
            <!-- Panneau de validation OSM -->
            <div class="professional-card" id="osmValidationPanel" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">‚úÖ Validation des donn√©es OSM</h3>
                    <div class="card-badge">Qualit√©</div>
                </div>
                <div class="p-3">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-value" id="osmDataQuality">-</div>
                            <div class="stat-label">Score qualit√© OSM</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="osmCompleteness">-</div>
                            <div class="stat-label">Compl√©tude (%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="osmFreshness">-</div>
                            <div class="stat-label">Fra√Æcheur donn√©es</div>
                        </div>
                    </div>
                    <div id="osmValidationDetails" class="mt-3"></div>
                </div>
            </div>
            
            <!-- Statistiques finales -->
            <div class="stats-container" id="finalStatsGrid"></div>
            
            <!-- Aper√ßu des donn√©es g√©n√©r√©es -->
            <div class="professional-card">
                <div class="card-header">
                    <h3 class="card-title">üìã Aper√ßu des donn√©es g√©n√©r√©es</h3>
                    <div class="card-badge">OSM + Consommation</div>
                </div>
                <div id="dataPreview" class="p-3"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!-- NOUVEAU: Script pour gestion OSM -->
    <script>
        /**
         * Gestion de l'interface bas√©e sur OpenStreetMap
         */

        let previewMap = null;
        let currentZoneData = null;
        let loadedBuildings = [];

        // Donn√©es des villes malaysiennes avec coordonn√©es
        const malaysiaCities = {
            'Kuala Lumpur': { lat: 3.1390, lon: 101.6869, population: 1800000, state: 'Federal Territory' },
            'George Town': { lat: 5.4164, lon: 100.3327, population: 708000, state: 'Penang' },
            'Ipoh': { lat: 4.5975, lon: 101.0901, population: 657000, state: 'Perak' },
            'Shah Alam': { lat: 3.0733, lon: 101.5185, population: 641000, state: 'Selangor' },
            'Petaling Jaya': { lat: 3.1073, lon: 101.6059, population: 613000, state: 'Selangor' },
            'Johor Bahru': { lat: 1.4927, lon: 103.7414, population: 497000, state: 'Johor' },
            'Kota Kinabalu': { lat: 5.9788, lon: 116.0753, population: 452000, state: 'Sabah' },
            'Kuching': { lat: 1.5533, lon: 110.3592, population: 325000, state: 'Sarawak' },
            'Ampang Jaya': { lat: 3.1500, lon: 101.7500, population: 315000, state: 'Selangor' },
            'Klang': { lat: 3.0319, lon: 101.4443, population: 290000, state: 'Selangor' }
        };

        /**
         * Initialisation de la carte de pr√©visualisation
         */
        function initializePreviewMap() {
            if (!previewMap) {
                previewMap = L.map('previewMap').setView([4.2105, 101.9758], 6); // Centre Malaisie

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(previewMap);

                console.log('‚úÖ Carte de pr√©visualisation initialis√©e');
            }
        }

        /**
         * Mise √† jour des options selon le type de zone
         */
        function updateZoneOptions() {
            const zoneType = document.getElementById('zoneType').value;
            
            // Masquer toutes les options
            document.getElementById('stateOptions').style.display = 'none';
            document.getElementById('cityOptions').style.display = 'none';
            document.getElementById('districtOptions').style.display = 'none';
            document.getElementById('customOptions').style.display = 'none';

            // Afficher les options appropri√©es
            switch(zoneType) {
                case 'state':
                    document.getElementById('stateOptions').style.display = 'block';
                    break;
                case 'city':
                    document.getElementById('cityOptions').style.display = 'block';
                    break;
                case 'district':
                    document.getElementById('districtOptions').style.display = 'block';
                    break;
                case 'custom':
                    document.getElementById('customOptions').style.display = 'block';
                    break;
            }

            updateZoneInfo();
        }

        /**
         * Mise √† jour des informations de la ville
         */
        function updateCityInfo() {
            const cityName = document.getElementById('selectedCity').value;
            const cityData = malaysiaCities[cityName];
            
            if (cityData) {
                document.getElementById('zoneNameDisplay').textContent = cityName;
                document.getElementById('zoneTypeDisplay').textContent = 'Ville';
                document.getElementById('zonePopulationDisplay').textContent = 
                    cityData.population.toLocaleString() + ' habitants';
                document.getElementById('zoneAreaDisplay').textContent = 'Variable selon limites';
                
                // Estimation des b√¢timents bas√©e sur la population
                const estimatedBuildings = Math.round(cityData.population * 0.15); // 15% ratio approximatif
                document.getElementById('estimatedBuildings').textContent = 
                    estimatedBuildings.toLocaleString();
                
                updateEstimation();
            }
        }

        /**
         * Mise √† jour g√©n√©rale des informations de zone
         */
        function updateZoneInfo() {
            const zoneType = document.getElementById('zoneType').value;
            
            switch(zoneType) {
                case 'country':
                    document.getElementById('zoneNameDisplay').textContent = 'Malaisie';
                    document.getElementById('zoneTypeDisplay').textContent = 'Pays entier';
                    document.getElementById('zonePopulationDisplay').textContent = '32M habitants';
                    document.getElementById('estimatedBuildings').textContent = '4.8M (estimation)';
                    break;
                case 'city':
                    updateCityInfo();
                    break;
                default:
                    document.getElementById('zoneNameDisplay').textContent = '-';
                    document.getElementById('zoneTypeDisplay').textContent = '-';
                    document.getElementById('zonePopulationDisplay').textContent = '-';
                    document.getElementById('estimatedBuildings').textContent = '-';
            }
        }

        /**
         * Mise √† jour de l'affichage du rayon
         */
        function updateRadiusDisplay() {
            const radius = document.getElementById('customRadius').value;
            document.getElementById('radiusDisplay').textContent = radius + 'm';
        }

        /**
         * Pr√©visualisation de la zone s√©lectionn√©e
         */
        function previewZone() {
            const zoneType = document.getElementById('zoneType').value;
            
            if (!previewMap) {
                initializePreviewMap();
            }

            updateMapStatus('üîÑ Pr√©paration de la pr√©visualisation...');

            switch(zoneType) {
                case 'city':
                    previewCity();
                    break;
                case 'state':
                    previewState();
                    break;
                case 'custom':
                    previewCustomZone();
                    break;
                case 'district':
                    previewDistrict();
                    break;
                case 'country':
                    previewCountry();
                    break;
            }
        }

        /**
         * Pr√©visualisation d'une ville
         */
        function previewCity() {
            const cityName = document.getElementById('selectedCity').value;
            const cityData = malaysiaCities[cityName];
            
            if (cityData) {
                previewMap.setView([cityData.lat, cityData.lon], 12);
                
                // Ajouter un marqueur pour la ville
                L.marker([cityData.lat, cityData.lon])
                    .addTo(previewMap)
                    .bindPopup(`
                        <b>${cityName}</b><br>
                        Population: ${cityData.population.toLocaleString()}<br>
                        √âtat: ${cityData.state}
                    `)
                    .openPopup();

                currentZoneData = {
                    type: 'city',
                    name: cityName,
                    center: [cityData.lat, cityData.lon],
                    radius: 15000, // Rayon approximatif d'une ville
                    ...cityData
                };

                updateMapStatus(`üìç Ville ${cityName} centr√©e sur la carte`);
                
                // Faire d√©filer jusqu'√† la carte
                document.getElementById('previewMapContainer').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        /**
         * Pr√©visualisation d'une zone personnalis√©e
         */
        function previewCustomZone() {
            const lat = parseFloat(document.getElementById('customLat').value);
            const lon = parseFloat(document.getElementById('customLon').value);
            const radius = parseInt(document.getElementById('customRadius').value);

            if (isNaN(lat) || isNaN(lon)) {
                alert('‚ö†Ô∏è Veuillez saisir des coordonn√©es valides');
                return;
            }

            previewMap.setView([lat, lon], 14);
            
            // Ajouter un cercle pour visualiser la zone
            L.circle([lat, lon], {
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.2,
                radius: radius
            }).addTo(previewMap);

            currentZoneData = {
                type: 'custom',
                name: `Zone personnalis√©e`,
                center: [lat, lon],
                radius: radius
            };

            updateMapStatus(`üìç Zone personnalis√©e (${radius}m) centr√©e`);
        }

        /**
         * Mise √† jour du statut de la carte
         */
        function updateMapStatus(message) {
            document.getElementById('mapStatus').textContent = message;
        }

        /**
         * Chargement des vrais b√¢timents depuis OSM
         */
        async function loadRealBuildings() {
            if (!currentZoneData) {
                alert('‚ö†Ô∏è Veuillez d\'abord pr√©visualiser une zone');
                return;
            }

            updateMapStatus('üîÑ Chargement des b√¢timents OSM...');
            updateLoadingProgress(10);

            try {
                const buildings = await fetchOSMBuildings(currentZoneData);
                displayBuildingsOnMap(buildings);
                updateBuildingStats(buildings);
                updateLoadingProgress(100);
                updateMapStatus(`‚úÖ ${buildings.length} b√¢timents charg√©s depuis OSM`);
                
                // Mettre √† jour l'estimation
                updateEstimationWithRealBuildings(buildings);
                
            } catch (error) {
                console.error('Erreur chargement OSM:', error);
                updateMapStatus('‚ùå Erreur lors du chargement OSM');
                alert('Erreur lors du chargement des donn√©es OSM. V√©rifiez la connexion.');
            }
        }

        /**
         * R√©cup√©ration des b√¢timents depuis l'API Overpass
         */
        async function fetchOSMBuildings(zoneData) {
            const { center, radius } = zoneData;
            const [lat, lon] = center;

            updateLoadingProgress(20);

            const query = `
                [out:json][timeout:60];
                (
                    way["building"](around:${radius},${lat},${lon});
                    relation["building"](around:${radius},${lat},${lon});
                );
                out geom;
            `;

            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query,
                headers: { 'Content-Type': 'text/plain' }
            });

            updateLoadingProgress(60);

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }

            const data = await response.json();
            updateLoadingProgress(80);

            return data.elements || [];
        }

        /**
         * Affichage des b√¢timents sur la carte
         */
        function displayBuildingsOnMap(buildings) {
            // Effacer les b√¢timents existants
            previewMap.eachLayer(layer => {
                if (layer instanceof L.Polygon) {
                    previewMap.removeLayer(layer);
                }
            });

            const buildingColors = {
                'residential': '#90EE90',
                'commercial': '#87CEEB',
                'industrial': '#A9A9A9',
                'office': '#B0C4DE',
                'retail': '#87CEFA',
                'hospital': '#FFB6C1',
                'school': '#DDA0DD',
                'hotel': '#FFDF7F',
                'default': '#D3D3D3'
            };

            loadedBuildings = buildings;
            let displayedCount = 0;

            buildings.forEach(building => {
                if (building.geometry && building.geometry.length > 2) {
                    try {
                        const coords = building.geometry.map(point => [point.lat, point.lon]);
                        const buildingType = getBuildingType(building.tags);
                        const color = buildingColors[buildingType] || buildingColors.default;

                        const polygon = L.polygon(coords, {
                            color: '#333',
                            weight: 1,
                            fillColor: color,
                            fillOpacity: 0.7
                        });

                        polygon.bindPopup(createBuildingPopup(building, buildingType));
                        polygon.addTo(previewMap);
                        displayedCount++;

                    } catch (error) {
                        console.warn('Erreur affichage b√¢timent:', error);
                    }
                }
            });

            document.getElementById('loadedBuildingsCount').textContent = displayedCount;
        }

        /**
         * D√©termination du type de b√¢timent OSM
         */
        function getBuildingType(tags) {
            if (!tags || !tags.building) return 'default';

            const buildingType = tags.building.toLowerCase();
            
            const typeMapping = {
                'residential': 'residential',
                'house': 'residential', 
                'apartments': 'residential',
                'commercial': 'commercial',
                'retail': 'retail',
                'shop': 'retail',
                'office': 'office',
                'industrial': 'industrial',
                'warehouse': 'industrial',
                'factory': 'industrial',
                'hospital': 'hospital',
                'clinic': 'hospital',
                'school': 'school',
                'university': 'school',
                'hotel': 'hotel',
                'restaurant': 'commercial'
            };

            return typeMapping[buildingType] || 'default';
        }

        /**
         * Cr√©ation du popup pour un b√¢timent
         */
        function createBuildingPopup(building, buildingType) {
            const tags = building.tags || {};
            let popup = `<b>Type:</b> ${buildingType}<br>`;
            
            if (tags.name) popup += `<b>Nom:</b> ${tags.name}<br>`;
            if (tags.height) popup += `<b>Hauteur:</b> ${tags.height}<br>`;
            if (tags['building:levels']) popup += `<b>√âtages:</b> ${tags['building:levels']}<br>`;
            if (tags['addr:street']) popup += `<b>Rue:</b> ${tags['addr:street']}<br>`;
            
            popup += `<b>ID OSM:</b> ${building.id}`;
            
            return popup;
        }

        /**
         * Mise √† jour des statistiques des b√¢timents
         */
        function updateBuildingStats(buildings) {
            const stats = {};
            
            buildings.forEach(building => {
                const type = getBuildingType(building.tags);
                stats[type] = (stats[type] || 0) + 1;
            });

            const statsContainer = document.getElementById('buildingTypesStats');
            let statsHTML = '';

            // Trier par nombre d√©croissant
            const sortedStats = Object.entries(stats).sort(([,a], [,b]) => b - a);

            sortedStats.forEach(([type, count]) => {
                const percentage = ((count / buildings.length) * 100).toFixed(1);
                statsHTML += `
                    <div class="data-item">
                        <span class="data-label">${type}:</span>
                        <span class="data-value">${count} (${percentage}%)</span>
                    </div>
                `;
            });

            statsContainer.innerHTML = statsHTML;

            // Mettre √† jour la r√©partition dans l'estimation
            updateBuildingTypesBreakdown(stats);
        }

        /**
         * Mise √† jour de la r√©partition par type de b√¢timent
         */
        function updateBuildingTypesBreakdown(stats) {
            const container = document.getElementById('buildingTypesBreakdown');
            let html = '';

            Object.entries(stats).forEach(([type, count]) => {
                html += `
                    <div class="data-card">
                        <div class="data-card-header">
                            <div class="data-card-title">${type}</div>
                        </div>
                        <div class="data-card-body">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">b√¢timents</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Mise √† jour de l'estimation avec les vrais b√¢timents
         */
        function updateEstimationWithRealBuildings(buildings) {
            const buildingCount = buildings.length;
            
            // Calculer les observations totales
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const freq = document.getElementById('freq').value;
            
            const timePoints = calculateTimePoints(startDate, endDate, freq);
            const totalObservations = buildingCount * timePoints;
            
            // Estimer la taille du fichier
            const avgBytesPerRecord = 150; // JSON avec m√©tadonn√©es
            const fileSizeBytes = totalObservations * avgBytesPerRecord;
            const fileSizeFormatted = formatFileSize(fileSizeBytes);
            
            // Estimer le temps de g√©n√©ration
            const generationTime = estimateGenerationTime(buildingCount, timePoints);
            
            // Mettre √† jour l'affichage
            document.getElementById('totalBuildings').textContent = buildingCount.toLocaleString();
            document.getElementById('totalObservations').textContent = totalObservations.toLocaleString();
            document.getElementById('fileSize').textContent = fileSizeFormatted;
            document.getElementById('generationTime').textContent = generationTime;
        }

        /**
         * Calcul du nombre de points temporels
         */
        function calculateTimePoints(startDate, endDate, freq) {
            const diffMs = endDate - startDate;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            
            const freqMultipliers = {
                '5T': 288,    // 288 points par jour
                '15T': 96,    // 96 points par jour
                '30T': 48,    // 48 points par jour
                '1H': 24,     // 24 points par jour
                '2H': 12,     // 12 points par jour
                '6H': 4,      // 4 points par jour
                '12H': 2,     // 2 points par jour
                '1D': 1,      // 1 point par jour
                '1W': 1/7,    // 1 point par semaine
                '1M': 1/30    // 1 point par mois
            };
            
            return Math.ceil(diffDays * (freqMultipliers[freq] || 48));
        }

        /**
         * Formatage de la taille de fichier
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        /**
         * Estimation du temps de g√©n√©ration
         */
        function estimateGenerationTime(buildings, timePoints) {
            const totalRecords = buildings * timePoints;
            
            if (totalRecords < 10000) return '< 10s';
            if (totalRecords < 100000) return '< 1min';
            if (totalRecords < 500000) return '1-3min';
            if (totalRecords < 1000000) return '3-5min';
            if (totalRecords < 5000000) return '5-15min';
            return '15+ min';
        }

        /**
         * Mise √† jour g√©n√©rale de l'estimation
         */
        function updateEstimation() {
            // Si on a des b√¢timents charg√©s, utiliser les vrais nombres
            if (loadedBuildings.length > 0) {
                updateEstimationWithRealBuildings(loadedBuildings);
                return;
            }

            // Sinon, utiliser les estimations bas√©es sur la zone
            const zoneType = document.getElementById('zoneType').value;
            let estimatedBuildings = 0;

            switch(zoneType) {
                case 'country':
                    estimatedBuildings = 4800000;
                    break;
                case 'city':
                    const cityName = document.getElementById('selectedCity').value;
                    const cityData = malaysiaCities[cityName];
                    if (cityData) {
                        estimatedBuildings = Math.round(cityData.population * 0.15);
                    }
                    break;
                case 'custom':
                    const radius = parseInt(document.getElementById('customRadius').value) || 1000;
                    estimatedBuildings = Math.round((radius / 1000) * (radius / 1000) * 100);
                    break;
                default:
                    estimatedBuildings = 1000;
            }

            // Calculer avec l'estimation
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const freq = document.getElementById('freq').value;
            
            const timePoints = calculateTimePoints(startDate, endDate, freq);
            const totalObservations = estimatedBuildings * timePoints;
            
            const avgBytesPerRecord = 150;
            const fileSizeBytes = totalObservations * avgBytesPerRecord;
            const fileSizeFormatted = formatFileSize(fileSizeBytes);
            
            const generationTime = estimateGenerationTime(estimatedBuildings, timePoints);
            
            document.getElementById('totalBuildings').textContent = estimatedBuildings.toLocaleString() + ' (est.)';
            document.getElementById('totalObservations').textContent = totalObservations.toLocaleString();
            document.getElementById('fileSize').textContent = fileSizeFormatted;
            document.getElementById('generationTime').textContent = generationTime;
        }

        /**
         * Mise √† jour de la barre de progression
         */
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }

        /**
         * G√©n√©ration des donn√©es depuis OSM
         */
        async function generateFromOSM() {
            if (loadedBuildings.length === 0) {
                if (confirm('üèóÔ∏è Aucun b√¢timent OSM charg√©. Voulez-vous d\'abord charger les b√¢timents r√©els ?')) {
                    await loadRealBuildings();
                }
                
                if (loadedBuildings.length === 0) {
                    alert('‚ö†Ô∏è Impossible de g√©n√©rer sans b√¢timents. Chargez d\'abord les donn√©es OSM.');
                    return;
                }
            }

            showLoading('üèóÔ∏è G√©n√©ration des donn√©es de consommation √©lectrique...');
            updateLoadingStatus('Pr√©paration des b√¢timents OSM...');

            try {
                // Pr√©parer les donn√©es pour l'API
                const requestData = {
                    zone_data: currentZoneData,
                    buildings_osm: loadedBuildings,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    freq: document.getElementById('freq').value,
                    generate_consumption: true
                };

                updateLoadingStatus('Envoi des donn√©es au serveur...');

                // Appeler l'API de g√©n√©ration
                const response = await fetch('/generate-from-osm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`Erreur serveur: ${response.status}`);
                }

                updateLoadingStatus('Traitement des donn√©es...');
                const result = await response.json();

                hideLoading();
                showResults(result);

            } catch (error) {
                hideLoading();
                console.error('Erreur g√©n√©ration OSM:', error);
                showAlert('Erreur lors de la g√©n√©ration: ' + error.message, 'error');
            }
        }

        /**
         * T√©l√©chargement direct depuis OSM
         */
        async function downloadFromOSM() {
            await generateFromOSM();
            // Le t√©l√©chargement sera d√©clench√© automatiquement par le serveur
        }

        /**
         * Aper√ßu des donn√©es OSM
         */
        function previewOSMData() {
            if (loadedBuildings.length === 0) {
                alert('‚ö†Ô∏è Chargez d\'abord les b√¢timents OSM pour voir l\'aper√ßu');
                return;
            }

            // Afficher un aper√ßu des 10 premiers b√¢timents
            const preview = loadedBuildings.slice(0, 10).map(building => ({
                id: building.id,
                type: getBuildingType(building.tags),
                tags: building.tags
            }));

            console.log('Aper√ßu des b√¢timents OSM:', preview);
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head><title>Aper√ßu B√¢timents OSM</title></head>
                <body>
                    <h2>Aper√ßu des ${loadedBuildings.length} b√¢timents charg√©s</h2>
                    <pre>${JSON.stringify(preview, null, 2)}</pre>
                </body>
                </html>
            `);
        }

        /**
         * Fonctions utilitaires pour l'interface
         */
        function showLoading(message) {
            document.getElementById('loading').style.display = 'flex';
            updateLoadingStatus(message);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loadingStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            if (!alertsContainer) return;

            const alertTypes = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'error': 'alert-error',
                'info': 'alert-info'
            };

            const alertClass = alertTypes[type] || alertTypes['info'];
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';

            alertsContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    <div class="alert-icon">${icon}</div>
                    <div>${message}</div>
                </div>
            `;
        }

        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;

            resultsDiv.style.display = 'block';
            resultsDiv.classList.add('fade-in');

            // Afficher les statistiques finales
            showFinalStats(data);

            // Afficher l'aper√ßu des donn√©es
            showDataPreview(data);

            showAlert('‚úÖ Donn√©es g√©n√©r√©es avec succ√®s √† partir d\'OpenStreetMap', 'success');
        }

        function showFinalStats(data) {
            // Implementation des statistiques finales
            if (data.stats) {
                const statsGrid = document.getElementById('finalStatsGrid');
                if (statsGrid) {
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.buildings_count || 0}</div>
                            <div class="stat-label">B√¢timents trait√©s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.total_records || 0}</div>
                            <div class="stat-label">Enregistrements g√©n√©r√©s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.unique_locations || 0}</div>
                            <div class="stat-label">Zones couvertes</div>
                        </div>
                    `;
                }
            }
        }

        function showDataPreview(data) {
            // Implementation de l'aper√ßu des donn√©es
            const previewDiv = document.getElementById('dataPreview');
            if (previewDiv && data.sample_data) {
                previewDiv.innerHTML = `
                    <h4>√âchantillon des donn√©es g√©n√©r√©es</h4>
                    <pre>${JSON.stringify(data.sample_data.slice(0, 5), null, 2)}</pre>
                `;
            }
        }

        /**
         * Initialisation de l'interface
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Interface OSM Zone Selector initialis√©e');
            
            // Initialiser la carte
            initializePreviewMap();
            
            // Initialiser les informations de zone
            updateZoneInfo();
            updateEstimation();
            
            // Configuration des √©v√©nements
            document.getElementById('loadRealBuildings').addEventListener('click', loadRealBuildings);
            document.getElementById('centerOnZone').addEventListener('click', () => {
                if (currentZoneData) {
                    previewMap.setView(currentZoneData.center, 12);
                }
            });
            document.getElementById('clearPreview').addEventListener('click', () => {
                previewMap.eachLayer(layer => {
                    if (layer instanceof L.Polygon || layer instanceof L.Marker || layer instanceof L.Circle) {
                        previewMap.removeLayer(layer);
                    }
                });
                loadedBuildings = [];
                document.getElementById('loadedBuildingsCount').textContent = '0';
                updateMapStatus('Carte effac√©e');
            });
            
            console.log('‚úÖ Interface pr√™te pour s√©lection de zones OSM');
        });

        // Message de bienvenue
        console.log(`
üó∫Ô∏è MALAYSIA OSM ZONE SELECTOR - INTERFACE CHARG√âE
=================================================
‚úÖ S√©lection de zones g√©ographiques (pays, √©tat, ville, quartier, personnalis√©e)
üèóÔ∏è Chargement automatique des vrais b√¢timents OpenStreetMap
üìä Estimation temps r√©el bas√©e sur donn√©es r√©elles
‚è∞ Conservation de l'horodatage et fr√©quences existantes
üîß G√©n√©ration avec vos r√®gles de consommation √©lectrique

Nouvelle approche:
1. S√©lectionner une zone g√©ographique
2. Pr√©visualiser sur la carte
3. Charger les vrais b√¢timents OSM
4. G√©n√©rer les donn√©es de consommation

Pr√™t pour la g√©n√©ration bas√©e sur OpenStreetMap ! üöÄ
        `);
    </script>
</body>
</html>